RESIDUAL-GRAVITY OVERLAY â€¢ FINAL IMPLEMENTATION BLUEPRINT
===============================================================

PURPOSE
-------
Provide an endâ€‘toâ€‘end execution plan, deliverable checklist, and risk
matrix for adding a Residualâ€‘Gravity corrective layer to Pulse.  Use
this document as the single sourceâ€‘ofâ€‘truth when tracking sprint
progress.

TABLE OF CONTENTS
-----------------
1.  Concept Summary
2.  Core Equations & Notation
3.  Phase Roadmap (AÂ â†’Â D)
4.  Deliverable Checklist
5.  Decision Gates
6.  Risk Register & Fuses
7.  Acceptance Metrics
8.  Glossary

--------------------------------------------------------------------
1.Â CONCEPT SUMMARY
--------------------------------------------------------------------
â€¢  Causal Core produces a forecast x_hat(t+1).
â€¢  Observations y(t+1) arrive from Iris pipeline.
â€¢  Residual  r(t+1) = y(t+1) â€“ x_hat(t+1).
â€¢  Symbolic pillars  s(t)  (Hope, Despair, â€¦) form anÂ Mâ€‘vector.
â€¢  Impact matrix  B(NÃ—M)  converts pillars into a corrective field
   g(t) = B Â· s(t).
â€¢  Corrected state  x_star(t+1) = x_hat(t+1) + Î» Â· g(t).
â€¢  B is learned online with SGD + momentum + L2; Î» is a gain.

--------------------------------------------------------------------
2.Â CORE EQUATIONS & NOTATION
--------------------------------------------------------------------
Dimensions
  N  = number of simulated state components
  M  = number of symbolic pillars

Update Rule
  grad_B  = residual_vec âŠ— s_vec  â€“  reg * B        # outer product
  v       = Î² * v  +  (1â€“Î²) * grad_B                # momentum
  B       = B + Î· * v                               # SGD step
  g_vec   = B Â· s_vec                               # gravity field
  x_hat   = x_hat + Î» * g_vec                       # apply gravity

Hyperâ€‘parameters
  Î»  (lambda)         global gain                [0.0Â â€“Â 1.0]
  Î·  (eta)            learning rate              (~1eâ€‘2)
  Î²  (beta)           momentum                   (~0.9)
  reg                 L2 regulariser             (~1eâ€‘3)
  Î´  (decay)          monthly weight decay       (optional)

--------------------------------------------------------------------
3.Â PHASE ROADMAP
--------------------------------------------------------------------
â€¢ StageÂ A : Scalar Baseline (1Â week)
  â€“ Finish `ResidualGravityEngine` v0.1 (scalar W).
  â€“ Implement parityâ€‘line heatâ€‘map in CLI/UI.
  â€“ Baseline metrics (RMSE, fragility, SUS_k).

â€¢ StageÂ B : DiagnosticsÂ & Governance (1Â week, parallel)
  â€“ GravityFuseMonitor     (||g|| spike, sign flip).
  â€“ WeightTimelineLogger   (EWMA dump â†’ Parquet).
  â€“ VarianceExplainer      (% variance explained by gravity).
  â€“ UI widgets (heatâ€‘map & weight dashboard).

â€¢ StageÂ C : Matrixâ€‘Gravity MVP (2â€“3Â weeks)
  â€“ Extend engine to matrix  B(NÃ—M).
  â€“ API: gravity() â†’ np.ndarray, update() accepts vectors.
  â€“ Pilot on 5Â variables Ã— current pillars.
  â€“ Acceptance:  Î”RMSEÂ â‰¥Â 10â€¯%  AND  Shadowâ€‘model ratioÂ <Â 30â€¯%.

â€¢ StageÂ D : Autoâ€‘TuneÂ & Regime Adaptation (ongoing)
  â€“ Optuna Bayesian search over {Î», Î·, Î², reg, optional Î»_vec}.
  â€“ Walkâ€‘forward train/validation windows.
  â€“ Monthly decay Î´ on B for regime shifts.
  â€“ Wire gravity metrics into Forecast Confidence Core.

--------------------------------------------------------------------
4.Â DELIVERABLE CHECKLIST
--------------------------------------------------------------------
CODEÂ FILES
  [ ] pulse/trust/residual_gravity_engine.py          (scalarÂ v0.1)
  [ ] pulse/trust/residual_gravity_engine.py          (matrixÂ v1.0)
  [ ] pulse/trust/gravity_fuse_monitor.py
  [ ] pulse/trust/variance_explainer.py
  [ ] pulse/memory/weight_timeline_logger.py
  [ ] ui/parity_dashboard.py
  [ ] cli/simulate.py  (flagÂ --enableâ€‘gravity,Â --gravityâ€‘scalar|matrix)

TESTS
  [ ] dev_tools/test_residual_gravity_scalar.py
  [ ] dev_tools/test_residual_gravity_matrix.py
  [ ] dev_tools/test_variance_explainer.py
  [ ] dev_tools/test_fuse_monitor.py

CONFIG / PARAM
  [ ] default_hyperparams.yaml (Î», Î·, Î², reg, Î´)
  [ ] optuna_config.yaml

DOCUMENTATION
  [ ] docs/residual_gravity_design.md  (this blueprint)
  [ ] docs/ui_parity_guide.md
  [ ] CHANGELOG.md  (entries for each stage)

METRICS & LOGS
  [ ] Parquet weight timelines in logs/gravity_weights/
  [ ] Fragility log entries when fuse trips
  [ ] StrategosDigest section â€œResidualâ€‘Gravity Metricsâ€

--------------------------------------------------------------------
5.Â DECISIONÂ GATES
--------------------------------------------------------------------
GateÂ G1  (after StageÂ A)  : Scalar overlay improves Î”RMSE â‰¥Â 5â€¯%.
GateÂ G2  (after StageÂ C)  : Matrix overlay satisfies acceptance test.
GateÂ G3  (after first autoâ€‘tune cycle) :
         Î» & reg stable across 3 validation windows.

If any gate fails â†’ rollback to previous stable tag and open Ruleâ€‘Gap
ticket for manual causal review.

--------------------------------------------------------------------
6.Â RISK REGISTER & FUSES
--------------------------------------------------------------------
| Risk ID | Description                             | Fuse / Action                |
|---------|-----------------------------------------|------------------------------|
| Râ€‘01    | Gravity dominates (>40â€¯% variance)      | Freeze Î», trigger rule audit |
| Râ€‘02    | B drift >Â 2ðœŽÂ in 1Â week                  | Halve Î·, double reg          |
| Râ€‘03    | Overâ€‘fit during hyperâ€‘opt               | Earlyâ€‘stop, walkâ€‘forward only|
| Râ€‘04    | Warmâ€‘up live shock                      | Ramp Î» fromÂ 0 to target over 50Â ticks |

THRESHOLDS
  THRESH_GRAV_FUSE   = RMS_g  >  3 Ã— RMS_g_train
  THRESH_SHADOW_VAR  = Var_explained_by_gravity > 0.30

--------------------------------------------------------------------
7.Â ACCEPTANCEÂ METRICS
--------------------------------------------------------------------
Metric SetÂ 1Â Â (Accuracy)Â :
  â€¢ Î”RMSE vs baseline
  â€¢ MAE for key state components
Metric SetÂ 2Â Â (Stability)Â :
  â€¢ RMS(B) 90â€‘day rolling
  â€¢ Signâ€‘flip count per month
Metric SetÂ 3Â Â (Trust/Fragility)Â :
  â€¢ Fuse triggers / 1000Â steps
  â€¢ Confidence penalty applied

Pass criteria for production:  
Â Â Î”RMSEÂ â‰¥Â 10â€¯% AND Fuse triggers <Â 1Â perÂ day over 30â€‘day pilot.

--------------------------------------------------------------------
8.Â GLOSSARY
--------------------------------------------------------------------
B           Impact matrix (NÃ—M)
g(t)        Gravity vector, corrective field
Î»           Global gain (scalar, possibly Î»_vec)
Î²           Momentum coefficient
reg         L2 regularisation factor
SUS_k       Symbolic Utility Score of pillarÂ k
Shadowâ€‘model Var_expl                   % variance explained by gravity
