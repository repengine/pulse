# Module Analysis: `simulation_engine/rules/reverse_rule_mapper.py`

## 1. Module Intent/Purpose

The primary role of the [`reverse_rule_mapper.py`](simulation_engine/rules/reverse_rule_mapper.py:2) module is to map observed state changes (deltas) to candidate rules. It achieves this by utilizing partial or approximate matching techniques against a set of predefined rule fingerprints. The module is intended to provide both a Command Line Interface (CLI) and an API for this delta-to-rule mapping functionality, though the provided code primarily implements the CLI aspects. All core rule matching logic is delegated to the [`engine.rules.rule_matching_utils`](simulation_engine/rules/rule_matching_utils.py:15) module.

## 2. Operational Status/Completeness

The module appears to be operational for its CLI-focused tasks:
*   Validating the schema of rule fingerprints.
*   Matching a given delta (set of key-value pairs representing state changes) to existing rules.

There are no explicit `TODO` comments or obvious placeholders within the provided code snippet. The module's completeness is largely dependent on the completeness and correctness of the imported [`rule_matching_utils.py`](simulation_engine/rules/rule_matching_utils.py:15) module.

## 3. Implementation Gaps / Unfinished Next Steps

*   **API Implementation:** The module's docstring mentions providing an "API for delta-to-rule mapping" ([`reverse_rule_mapper.py:7`](simulation_engine/rules/reverse_rule_mapper.py:7)). However, the current code only implements a CLI interface within the `if __name__ == "__main__":` block ([`reverse_rule_mapper.py:21`](simulation_engine/rules/reverse_rule_mapper.py:21)). Callable functions or classes that would constitute a Python API for this mapping are not explicitly defined in this module. The core logic is imported, so an API could be a thin wrapper around those imported functions.
*   **Dependency on `rule_matching_utils`:** The module's functionality is entirely reliant on [`rule_matching_utils.py`](simulation_engine/rules/rule_matching_utils.py:15). Any gaps or unfinished parts in that utility module would directly impact this mapper.

## 4. Connections & Dependencies

### Direct Project Module Imports
*   [`engine.rules.rule_matching_utils`](simulation_engine/rules/rule_matching_utils.py:15):
    *   [`get_all_rule_fingerprints()`](simulation_engine/rules/rule_matching_utils.py:16)
    *   [`match_rule_by_delta()`](simulation_engine/rules/rule_matching_utils.py:17)
    *   [`validate_fingerprint_schema()`](simulation_engine/rules/rule_matching_utils.py:18)

### External Library Dependencies
*   [`json`](https://docs.python.org/3/library/json.html) ([`reverse_rule_mapper.py:13`](simulation_engine/rules/reverse_rule_mapper.py:13)) - Standard library.
*   `typing` (specifically `Dict`, `List`, `Tuple`, `Optional`) ([`reverse_rule_mapper.py:14`](simulation_engine/rules/reverse_rule_mapper.py:14)) - Standard library.
*   `argparse` ([`reverse_rule_mapper.py:22`](simulation_engine/rules/reverse_rule_mapper.py:22)) - Standard library, used for CLI argument parsing.

### Interaction via Shared Data
*   **Rule Fingerprints:** The module processes rule fingerprints obtained via [`get_all_rule_fingerprints()`](simulation_engine/rules/rule_matching_utils.py:16) from [`rule_matching_utils.py`](simulation_engine/rules/rule_matching_utils.py:15). The actual source of these fingerprints (e.g., a JSON file like `rule_fingerprints.json`) is managed by the utility module.

### Input/Output Files
*   **Input:** Indirectly consumes rule fingerprint data, likely from a file loaded by [`rule_matching_utils.py`](simulation_engine/rules/rule_matching_utils.py:15).
*   **Output:** Prints validation results or matching rules to `stdout` when used as a CLI tool. No direct file outputs are generated by this module itself.

## 5. Function and Class Example Usages

The module is primarily designed to be used as a CLI tool. The `if __name__ == "__main__":` block ([`reverse_rule_mapper.py:21`](simulation_engine/rules/reverse_rule_mapper.py:21)) demonstrates its usage:

*   **Validate rule fingerprint schema:**
    ```bash
    python simulation_engine/rules/reverse_rule_mapper.py --validate
    ```
    This command will load all rule fingerprints using [`get_all_rule_fingerprints()`](simulation_engine/rules/rule_matching_utils.py:16) and then validate their structure using [`validate_fingerprint_schema()`](simulation_engine/rules/rule_matching_utils.py:18).

*   **Match a delta to rules:**
    ```bash
    python simulation_engine/rules/reverse_rule_mapper.py --match key1=val1 key2=val2 ...
    ```
    Example:
    ```bash
    python simulation_engine/rules/reverse_rule_mapper.py --match temperature_change=2.5 humidity_change=-0.5
    ```
    This command parses the `key=value` pairs into a delta dictionary, loads fingerprints, and then uses [`match_rule_by_delta()`](simulation_engine/rules/rule_matching_utils.py:17) to find matching rules. The values are parsed as `float` ([`reverse_rule_mapper.py:39`](simulation_engine/rules/reverse_rule_mapper.py:39)).

## 6. Hardcoding Issues

*   **Float Conversion:** When parsing delta values from the CLI for the `--match` argument, values are directly converted to `float` ([`reverse_rule_mapper.py:39`](simulation_engine/rules/reverse_rule_mapper.py:39)): `delta[k] = float(v)`. This assumes all delta values are numerical and can be represented as floats. If other data types are expected for deltas, this would be a limitation.

No other significant hardcoded paths, secrets, or critical magic numbers were identified directly within this module's code.

## 7. Coupling Points

*   **High Coupling with `rule_matching_utils`:** The module is tightly coupled to [`engine.rules.rule_matching_utils.py`](simulation_engine/rules/rule_matching_utils.py:15). All its core functionalities (getting fingerprints, matching deltas, validating schema) are delegated to functions imported from this utility module. Changes to the API or behavior of `rule_matching_utils` would directly impact `reverse_rule_mapper.py`.

## 8. Existing Tests

Based on the provided file list and common project structures, a dedicated test file such as `tests/simulation_engine/rules/test_reverse_rule_mapper.py` is not immediately visible.
However, testing for the core logic likely resides within the tests for the [`engine.rules.rule_matching_utils`](simulation_engine/rules/rule_matching_utils.py:15) module, or potentially within a broader integration test suite like [`tests/test_reverse_rule_engine.py`](tests/test_reverse_rule_engine.py) if this mapper plays a role in the reverse rule engine's workflow.

Without direct visibility into the test files for `rule_matching_utils`, a precise assessment of test coverage for the logic used by this mapper is not possible from this module alone. The CLI interface itself might not be explicitly unit-tested unless specific CLI testing practices are in place.

## 9. Module Architecture and Flow

### Architecture
The module is a simple Python script designed to function as a CLI tool. It uses the standard `argparse` library for command-line argument parsing and conditional logic to execute different functionalities based on the provided arguments. It acts as a lightweight wrapper around more complex logic found in [`rule_matching_utils.py`](simulation_engine/rules/rule_matching_utils.py:15).

### Primary Data/Control Flows
1.  **Initialization:** Imports necessary libraries and functions from [`rule_matching_utils.py`](simulation_engine/rules/rule_matching_utils.py:15).
2.  **CLI Argument Parsing (if run as script):**
    *   The `if __name__ == "__main__":` block ([`reverse_rule_mapper.py:21`](simulation_engine/rules/reverse_rule_mapper.py:21)) initializes `argparse`.
    *   It defines two main arguments: `--validate` (boolean flag) and `--match` (takes one or more `key=value` strings).
3.  **Validation Flow (`--validate`):**
    *   Calls [`get_all_rule_fingerprints()`](simulation_engine/rules/rule_matching_utils.py:28) to load rule fingerprint data.
    *   Passes the loaded fingerprints to [`validate_fingerprint_schema()`](simulation_engine/rules/rule_matching_utils.py:29).
    *   Prints "✅ All fingerprints valid." or "❌ Schema errors:" followed by specific error messages to `stdout`.
4.  **Matching Flow (`--match`):**
    *   Parses the list of `key=value` strings into a `delta` dictionary, converting values to `float` ([`reverse_rule_mapper.py:36-39`](simulation_engine/rules/reverse_rule_mapper.py:36-39)).
    *   Calls [`get_all_rule_fingerprints()`](simulation_engine/rules/rule_matching_utils.py:40).
    *   Calls [`match_rule_by_delta()`](simulation_engine/rules/rule_matching_utils.py:40) with the parsed `delta` and the loaded fingerprints.
    *   Prints the list of matched rules to `stdout`.
5.  **Default Flow (no recognized arguments):**
    *   If neither `--validate` nor `--match` (or other future arguments) are provided, `argparse` prints the help message for the CLI tool ([`reverse_rule_mapper.py:43`](simulation_engine/rules/reverse_rule_mapper.py:43)).

## 10. Naming Conventions

The module generally adheres to Python's PEP 8 naming conventions:
*   **Module Name:** `reverse_rule_mapper.py` (snake_case).
*   **Variables:** `fps`, `errs`, `delta`, `kv`, `k`, `v` are short but used in limited scopes, which is acceptable. `parser`, `args` are standard for `argparse`.
*   **Functions:** The imported functions ([`get_all_rule_fingerprints`](simulation_engine/rules/rule_matching_utils.py:16), [`match_rule_by_delta`](simulation_engine/rules/rule_matching_utils.py:17), [`validate_fingerprint_schema`](simulation_engine/rules/rule_matching_utils.py:18)) use snake_case.

No significant deviations from PEP 8 or potential AI assumption errors in naming were observed within this module. The naming is consistent and clear for its scope.